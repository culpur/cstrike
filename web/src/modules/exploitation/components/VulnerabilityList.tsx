/**
 * Vulnerability List Component
 */

import { Shield, AlertTriangle, Info } from 'lucide-react';
import { formatDateTime } from '@utils/index';
import type { Vulnerability, SeverityLevel } from '@/types/exploitation';

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[];
}

export function VulnerabilityList({ vulnerabilities }: VulnerabilityListProps) {
  if (vulnerabilities.length === 0) {
    return (
      <div className="text-center py-12">
        <Shield className="w-12 h-12 text-grok-text-muted mx-auto mb-3" />
        <p className="text-grok-text-muted">No vulnerabilities discovered yet</p>
      </div>
    );
  }

  const sortedVulns = [...vulnerabilities].sort((a, b) => {
    const severityOrder: Record<SeverityLevel, number> = {
      critical: 0,
      high: 1,
      medium: 2,
      low: 3,
      info: 4,
    };
    return severityOrder[a.severity] - severityOrder[b.severity];
  });

  return (
    <div className="space-y-3">
      {sortedVulns.map((vuln) => (
        <VulnerabilityCard key={vuln.id} vulnerability={vuln} />
      ))}
    </div>
  );
}

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
}

function VulnerabilityCard({ vulnerability }: VulnerabilityCardProps) {
  const severityConfig = getSeverityConfig(vulnerability.severity);

  return (
    <div className="p-4 bg-grok-surface-2 rounded-lg border border-grok-border hover:border-grok-border-hover transition-colors">
      <div className="flex items-start gap-3">
        <div className="flex-shrink-0 mt-1">
          <severityConfig.icon className={`w-5 h-5 ${severityConfig.color}`} />
        </div>
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between gap-3 mb-2">
            <div className="flex-1">
              <h4 className="text-sm font-semibold text-grok-text-heading mb-1">
                {vulnerability.name}
              </h4>
              {vulnerability.cve && (
                <p className="text-xs text-grok-text-muted mb-1">
                  CVE: {vulnerability.cve}
                </p>
              )}
            </div>
            <div className="flex items-center gap-2">
              <span
                className={`px-2 py-1 text-xs font-medium rounded ${severityConfig.bgColor} ${severityConfig.color}`}
              >
                {vulnerability.severity.toUpperCase()}
              </span>
              {vulnerability.cvss_score && (
                <span className="px-2 py-1 text-xs font-medium bg-grok-surface-3 text-grok-text-heading rounded">
                  CVSS: {vulnerability.cvss_score}
                </span>
              )}
            </div>
          </div>

          <p className="text-sm text-grok-text-body mb-3">
            {vulnerability.description}
          </p>

          <div className="flex flex-wrap items-center gap-3 text-xs text-grok-text-muted">
            <div className="flex items-center gap-1">
              <span className="font-medium">Tool:</span>
              <span>{vulnerability.tool}</span>
            </div>
            <div className="flex items-center gap-1">
              <span className="font-medium">Exploitable:</span>
              <span
                className={
                  vulnerability.exploitable
                    ? 'text-grok-exploit-red font-medium'
                    : 'text-grok-text-muted'
                }
              >
                {vulnerability.exploitable ? 'Yes' : 'No'}
              </span>
            </div>
            {vulnerability.exploit_used && (
              <div className="flex items-center gap-1">
                <span className="font-medium">Exploit:</span>
                <span className="text-grok-success">{vulnerability.exploit_used}</span>
              </div>
            )}
            <div className="flex items-center gap-1">
              <span className="font-medium">Discovered:</span>
              <span>{formatDateTime(vulnerability.discovered_at)}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function getSeverityConfig(severity: SeverityLevel) {
  switch (severity) {
    case 'critical':
      return {
        icon: AlertTriangle,
        color: 'text-grok-error',
        bgColor: 'bg-grok-error/10',
      };
    case 'high':
      return {
        icon: AlertTriangle,
        color: 'text-grok-exploit-red',
        bgColor: 'bg-grok-exploit-red/10',
      };
    case 'medium':
      return {
        icon: Shield,
        color: 'text-grok-warning',
        bgColor: 'bg-grok-warning/10',
      };
    case 'low':
      return {
        icon: Shield,
        color: 'text-grok-info',
        bgColor: 'bg-grok-info/10',
      };
    case 'info':
      return {
        icon: Info,
        color: 'text-grok-text-muted',
        bgColor: 'bg-grok-surface-3',
      };
  }
}
