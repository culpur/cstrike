/**
 * Exploit Results Panel - Display exploitation results and real-time progress
 */

import { useState, useMemo } from 'react';
import {
  CheckCircle,
  XCircle,
  Clock,
  Download,
  Terminal,
  Key,
  FileText,
  AlertTriangle,
  Shield,
  Activity,
} from 'lucide-react';
import { Panel, Button } from '@components/ui';
import { formatDateTime, formatTime, exportAsJson } from '@utils/index';
import type { ExploitationResult } from '@/types/exploitation';
import { VulnerabilityList } from './VulnerabilityList';
import { ShellList } from './ShellList';
import { CredentialList } from './CredentialList';
import { FileList } from './FileList';
import { Timeline } from './Timeline';

type TabType = 'overview' | 'vulnerabilities' | 'shells' | 'credentials' | 'files' | 'timeline';

interface ExploitResultsPanelProps {
  result: ExploitationResult;
  onClose?: () => void;
}

export function ExploitResultsPanel({ result, onClose }: ExploitResultsPanelProps) {
  const [activeTab, setActiveTab] = useState<TabType>('overview');

  const duration = useMemo(() => {
    if (!result.completed_at) {
      return Math.floor((Date.now() - result.started_at) / 1000);
    }
    return Math.floor((result.completed_at - result.started_at) / 1000);
  }, [result.started_at, result.completed_at]);

  const formatDuration = (seconds: number): string => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
    if (minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
  };

  const handleExportJson = () => {
    exportAsJson(result, `exploitation-${result.exploit_id}`);
  };

  const handleExportMarkdown = () => {
    const markdown = generateMarkdownReport(result);
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `exploitation-${result.exploit_id}.md`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const statusIcon = {
    running: <Clock className="w-5 h-5 text-grok-warning animate-pulse" />,
    completed: <CheckCircle className="w-5 h-5 text-grok-success" />,
    failed: <XCircle className="w-5 h-5 text-grok-error" />,
  }[result.status];

  const statusColor = {
    running: 'text-grok-warning',
    completed: 'text-grok-success',
    failed: 'text-grok-error',
  }[result.status];

  const tabs: { id: TabType; label: string; count?: number; icon: typeof Activity }[] = [
    { id: 'overview', label: 'Overview', icon: Activity },
    {
      id: 'vulnerabilities',
      label: 'Vulnerabilities',
      count: result.vulnerabilities.length,
      icon: Shield,
    },
    { id: 'shells', label: 'Shells', count: result.shells.length, icon: Terminal },
    { id: 'credentials', label: 'Credentials', count: result.credentials.length, icon: Key },
    { id: 'files', label: 'Files', count: result.files.length, icon: FileText },
    { id: 'timeline', label: 'Timeline', count: result.timeline.length, icon: Clock },
  ];

  return (
    <div>
      <Panel
        title="Exploitation Results"
      >
        <div className="mb-4">
          <div className="flex items-center justify-between w-full">
          <div className="flex items-center gap-3">
            {statusIcon}
            <div>
              <h3 className="text-lg font-semibold text-grok-text-heading">
                Exploitation Results
              </h3>
              <p className="text-sm text-grok-text-muted">
                {result.target} - {formatDateTime(result.started_at)}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Button size="sm" variant="ghost" onClick={handleExportJson}>
              <Download className="w-4 h-4 mr-2" />
              JSON
            </Button>
            <Button size="sm" variant="ghost" onClick={handleExportMarkdown}>
              <Download className="w-4 h-4 mr-2" />
              Markdown
            </Button>
            {onClose && (
              <Button size="sm" variant="ghost" onClick={onClose}>
                Close
              </Button>
            )}
          </div>
        </div>
        </div>
      {/* Status Bar */}
      <div className="mb-6 p-4 bg-grok-surface-2 rounded-lg border border-grok-border">
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div>
            <p className="text-xs text-grok-text-muted mb-1">Status</p>
            <p className={`text-sm font-medium ${statusColor} capitalize`}>
              {result.status}
            </p>
          </div>
          <div>
            <p className="text-xs text-grok-text-muted mb-1">Duration</p>
            <p className="text-sm font-medium text-grok-text-heading">
              {formatDuration(duration)}
            </p>
          </div>
          <div>
            <p className="text-xs text-grok-text-muted mb-1">Vulnerabilities</p>
            <p className="text-sm font-medium text-grok-text-heading">
              {result.vulnerabilities.length}
            </p>
          </div>
          <div>
            <p className="text-xs text-grok-text-muted mb-1">Shells</p>
            <p className="text-sm font-medium text-grok-text-heading">
              {result.shells.length}
            </p>
          </div>
          <div>
            <p className="text-xs text-grok-text-muted mb-1">Credentials</p>
            <p className="text-sm font-medium text-grok-text-heading">
              {result.credentials.length}
            </p>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-4 border-b border-grok-border overflow-x-auto">
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap ${
              activeTab === tab.id
                ? 'text-grok-exploit-red border-b-2 border-grok-exploit-red'
                : 'text-grok-text-muted hover:text-grok-text-heading'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
            {tab.count !== undefined && tab.count > 0 && (
              <span className="px-2 py-0.5 text-xs bg-grok-surface-3 rounded-full">
                {tab.count}
              </span>
            )}
          </button>
        ))}
      </div>

      {/* Tab Content */}
      <div className="space-y-4">
        {activeTab === 'overview' && (
          <OverviewTab result={result} duration={duration} />
        )}
        {activeTab === 'vulnerabilities' && (
          <VulnerabilityList vulnerabilities={result.vulnerabilities} />
        )}
        {activeTab === 'shells' && <ShellList shells={result.shells} />}
        {activeTab === 'credentials' && (
          <CredentialList credentials={result.credentials} />
        )}
        {activeTab === 'files' && <FileList files={result.files} />}
        {activeTab === 'timeline' && <Timeline events={result.timeline} />}
      </div>
    </Panel>
    </div>
  );
}

interface OverviewTabProps {
  result: ExploitationResult;
  duration: number;
}

function OverviewTab({ result }: OverviewTabProps) {
  const criticalVulns = result.vulnerabilities.filter((v) => v.severity === 'critical').length;
  const highVulns = result.vulnerabilities.filter((v) => v.severity === 'high').length;
  const activeShells = result.shells.filter((s) => s.active).length;
  const validatedCreds = result.credentials.filter((c) => c.validated).length;
  const sensitiveFiles = result.files.filter((f) => f.sensitive).length;

  return (
    <div className="space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <SummaryCard
          icon={<Shield className="w-6 h-6 text-grok-exploit-red" />}
          title="Critical Findings"
          value={criticalVulns + highVulns}
          subtitle={`${criticalVulns} critical, ${highVulns} high`}
          color="text-grok-exploit-red"
        />
        <SummaryCard
          icon={<Terminal className="w-6 h-6 text-grok-success" />}
          title="Active Shells"
          value={activeShells}
          subtitle={`${result.shells.length} total obtained`}
          color="text-grok-success"
        />
        <SummaryCard
          icon={<Key className="w-6 h-6 text-grok-warning" />}
          title="Validated Credentials"
          value={validatedCreds}
          subtitle={`${result.credentials.length} total extracted`}
          color="text-grok-warning"
        />
      </div>

      {/* Key Events */}
      <div>
        <h4 className="text-sm font-semibold text-grok-text-heading mb-3">
          Key Events
        </h4>
        <div className="space-y-2">
          {result.timeline
            .filter((e) => e.type === 'success' || e.type === 'error')
            .slice(-5)
            .map((event) => (
              <div
                key={event.id}
                className="flex items-start gap-3 p-3 bg-grok-surface-2 rounded border border-grok-border"
              >
                <div className="flex-shrink-0 mt-0.5">
                  {event.type === 'success' ? (
                    <CheckCircle className="w-4 h-4 text-grok-success" />
                  ) : (
                    <AlertTriangle className="w-4 h-4 text-grok-error" />
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm text-grok-text-body">{event.message}</p>
                  <p className="text-xs text-grok-text-muted mt-1">
                    {formatTime(event.timestamp)} - {event.phase}
                  </p>
                </div>
              </div>
            ))}
        </div>
      </div>

      {/* Statistics */}
      <div>
        <h4 className="text-sm font-semibold text-grok-text-heading mb-3">
          Statistics
        </h4>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <StatItem label="Total Vulnerabilities" value={result.vulnerabilities.length} />
          <StatItem label="Exploitable" value={result.vulnerabilities.filter((v) => v.exploitable).length} />
          <StatItem label="Sensitive Files" value={sensitiveFiles} />
          <StatItem label="Timeline Events" value={result.timeline.length} />
        </div>
      </div>
    </div>
  );
}

interface SummaryCardProps {
  icon: React.ReactNode;
  title: string;
  value: number;
  subtitle: string;
  color: string;
}

function SummaryCard({ icon, title, value, subtitle, color }: SummaryCardProps) {
  return (
    <div className="p-4 bg-grok-surface-2 rounded-lg border border-grok-border">
      <div className="flex items-start gap-3">
        <div className="flex-shrink-0">{icon}</div>
        <div className="flex-1 min-w-0">
          <p className="text-xs text-grok-text-muted mb-1">{title}</p>
          <p className={`text-2xl font-bold ${color}`}>{value}</p>
          <p className="text-xs text-grok-text-muted mt-1">{subtitle}</p>
        </div>
      </div>
    </div>
  );
}

interface StatItemProps {
  label: string;
  value: number;
}

function StatItem({ label, value }: StatItemProps) {
  return (
    <div className="p-3 bg-grok-surface-2 rounded border border-grok-border">
      <p className="text-xs text-grok-text-muted mb-1">{label}</p>
      <p className="text-xl font-bold text-grok-text-heading">{value}</p>
    </div>
  );
}

function generateMarkdownReport(result: ExploitationResult): string {
  const duration = result.completed_at
    ? Math.floor((result.completed_at - result.started_at) / 1000)
    : Math.floor((Date.now() - result.started_at) / 1000);

  const formatDuration = (seconds: number): string => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
    if (minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
  };

  return `# Exploitation Report

## Target Information
- **Target**: ${result.target}
- **Exploit ID**: ${result.exploit_id}
- **Status**: ${result.status}
- **Started**: ${formatDateTime(result.started_at)}
- **Duration**: ${formatDuration(duration)}
${result.completed_at ? `- **Completed**: ${formatDateTime(result.completed_at)}` : ''}

## Summary
- **Vulnerabilities Discovered**: ${result.vulnerabilities.length}
- **Shells Obtained**: ${result.shells.length}
- **Credentials Extracted**: ${result.credentials.length}
- **Files Downloaded**: ${result.files.length}

## Vulnerabilities

${result.vulnerabilities.map((v) => `### ${v.name}
- **Severity**: ${v.severity.toUpperCase()}
${v.cve ? `- **CVE**: ${v.cve}` : ''}
${v.cvss_score ? `- **CVSS Score**: ${v.cvss_score}` : ''}
- **Description**: ${v.description}
- **Tool**: ${v.tool}
- **Exploitable**: ${v.exploitable ? 'Yes' : 'No'}
${v.exploit_used ? `- **Exploit Used**: ${v.exploit_used}` : ''}
`).join('\n')}

## Shells

${result.shells.map((s) => `### ${s.type.toUpperCase()} Shell
- **Host**: ${s.host}:${s.port}
- **User**: ${s.user || 'N/A'}
- **Privilege**: ${s.privilege_level}
- **Status**: ${s.active ? 'Active' : 'Inactive'}
- **Obtained**: ${formatDateTime(s.obtained_at)}
`).join('\n')}

## Credentials

${result.credentials.map((c) => `### ${c.username}
- **Type**: ${c.type}
- **Service**: ${c.service || 'N/A'}
- **Validated**: ${c.validated ? 'Yes' : 'No'}
- **Source**: ${c.source}
`).join('\n')}

## Files Downloaded

${result.files.map((f) => `- **${f.path}** (${f.size} bytes) - ${f.type}
  - Sensitive: ${f.sensitive ? 'Yes' : 'No'}
  - Downloaded: ${formatDateTime(f.downloaded_at)}
`).join('\n')}

## Timeline

${result.timeline.map((e) => `- **[${formatTime(e.timestamp)}]** [${e.phase}] ${e.message}`).join('\n')}

---
*Report generated on ${formatDateTime(Date.now())}*
`;
}
