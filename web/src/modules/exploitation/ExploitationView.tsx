/**
 * Exploitation View - Web and network exploitation controls
 */

import { useState } from 'react';
import { Crosshair, Zap, Shield } from 'lucide-react';
import { Button, Panel, Input } from '@components/ui';
import { useUIStore } from '@stores/uiStore';
import { useReconStore } from '@stores/reconStore';
import { useExploitationStore } from '@stores/exploitationStore';
import { apiService } from '@services/api';
import { ExploitResultsPanel } from './components/ExploitResultsPanel';
import { ExploitationResultsList } from './components/ExploitationResultsList';

export function ExploitationView() {
  const [webExploitConfig, setWebExploitConfig] = useState({
    nuclei: true,
    ffuf: true,
    sqlmap: false,
  });

  const [bruteforceConfig, setBruteforceConfig] = useState({
    target: '',
    service: 'SSH',
    port: 22,
    wordlist: 'rockyou.txt',
  });

  const [selectedTarget, setSelectedTarget] = useState('');
  const { addToast } = useUIStore();
  const { targets } = useReconStore();
  const { selectedResultId, setSelectedResult, getResult } = useExploitationStore();

  const [isExploiting, setIsExploiting] = useState(false);

  const selectedResult = selectedResultId ? getResult(selectedResultId) : undefined;

  const handleStartWebExploit = async () => {
    if (!selectedTarget) {
      addToast({
        type: 'warning',
        message: 'Please select a target',
      });
      return;
    }

    setIsExploiting(true);
    try {
      // Get enabled tools from config
      const enabledTools = Object.entries(webExploitConfig)
        .filter(([_, enabled]) => enabled)
        .map(([tool, _]) => tool);

      const result = await apiService.startExploitation(selectedTarget, enabledTools);
      addToast({
        type: 'success',
        message: `Exploitation started with ${enabledTools.join(', ')} (ID: ${result.exploit_id})`,
      });
    } catch (error) {
      addToast({
        type: 'error',
        message: error instanceof Error ? error.message : 'Failed to start exploitation',
      });
    } finally {
      setIsExploiting(false);
    }
  };

  const handleStartBruteforce = async () => {
    if (!bruteforceConfig.target) {
      addToast({
        type: 'warning',
        message: 'Please enter a target',
      });
      return;
    }

    setIsExploiting(true);
    try {
      const result = await apiService.startBruteforce(bruteforceConfig);
      addToast({
        type: 'success',
        message: `Bruteforce ${bruteforceConfig.service} started on ${bruteforceConfig.target}:${bruteforceConfig.port} (ID: ${result.exploit_id})`,
      });
    } catch (error) {
      addToast({
        type: 'error',
        message: error instanceof Error ? error.message : 'Failed to start bruteforce',
      });
    } finally {
      setIsExploiting(false);
    }
  };

  const handleViewResult = (exploitId: string) => {
    setSelectedResult(exploitId);
  };

  return (
    <div className="h-full overflow-auto p-6 space-y-6">
      <h1 className="text-2xl font-bold text-grok-text-heading">Exploitation</h1>

      {/* Show detailed results panel if a result is selected */}
      {selectedResult && (
        <ExploitResultsPanel
          result={selectedResult}
          onClose={() => setSelectedResult(null)}
        />
      )}

      {/* Web Exploitation */}
      <Panel title="Web Exploitation">
        <div className="space-y-4">
          <p className="text-sm text-grok-text-muted">
            Automated web application vulnerability exploitation using industry-standard
            tools.
          </p>

          {/* Target Selection */}
          <div>
            <label className="block text-sm font-medium text-grok-text-heading mb-2">
              Select Target
            </label>
            <select
              value={selectedTarget}
              onChange={(e) => setSelectedTarget(e.target.value)}
              className="w-full px-3 py-2 bg-grok-surface-2 border border-grok-border rounded text-grok-text-body focus:outline-none focus:border-grok-recon-blue"
            >
              <option value="">-- Select a target --</option>
              {targets.map((target) => (
                <option key={target.id} value={target.url}>
                  {target.url}
                </option>
              ))}
            </select>
          </div>

          <div className="space-y-3">
            <label className="flex items-center gap-3 p-3 bg-grok-surface-2 rounded border border-grok-border cursor-pointer hover:border-grok-recon-blue transition-colors">
              <input
                type="checkbox"
                checked={webExploitConfig.nuclei}
                onChange={(e) =>
                  setWebExploitConfig({
                    ...webExploitConfig,
                    nuclei: e.target.checked,
                  })
                }
                className="rounded border-grok-border"
              />
              <div className="flex-1">
                <p className="text-sm font-medium text-grok-text-heading">Nuclei</p>
                <p className="text-xs text-grok-text-muted">
                  Template-based vulnerability scanner
                </p>
              </div>
              <Zap className="w-5 h-5 text-grok-warning" />
            </label>

            <label className="flex items-center gap-3 p-3 bg-grok-surface-2 rounded border border-grok-border cursor-pointer hover:border-grok-recon-blue transition-colors">
              <input
                type="checkbox"
                checked={webExploitConfig.ffuf}
                onChange={(e) =>
                  setWebExploitConfig({
                    ...webExploitConfig,
                    ffuf: e.target.checked,
                  })
                }
                className="rounded border-grok-border"
              />
              <div className="flex-1">
                <p className="text-sm font-medium text-grok-text-heading">FFuF</p>
                <p className="text-xs text-grok-text-muted">Fast web fuzzer</p>
              </div>
              <Crosshair className="w-5 h-5 text-grok-exploit-red" />
            </label>

            <label className="flex items-center gap-3 p-3 bg-grok-surface-2 rounded border border-grok-border cursor-pointer hover:border-grok-recon-blue transition-colors">
              <input
                type="checkbox"
                checked={webExploitConfig.sqlmap}
                onChange={(e) =>
                  setWebExploitConfig({
                    ...webExploitConfig,
                    sqlmap: e.target.checked,
                  })
                }
                className="rounded border-grok-border"
              />
              <div className="flex-1">
                <p className="text-sm font-medium text-grok-text-heading">SQLMap</p>
                <p className="text-xs text-grok-text-muted">
                  SQL injection exploitation
                </p>
              </div>
              <Shield className="w-5 h-5 text-grok-error" />
            </label>
          </div>

          <Button onClick={handleStartWebExploit} isLoading={isExploiting} className="w-full">
            <Crosshair className="w-4 h-4 mr-2" />
            Start Exploitation Chain
          </Button>
        </div>
      </Panel>

      {/* Bruteforce */}
      <Panel title="Bruteforce Attack">
        <div className="space-y-4">
          <p className="text-sm text-grok-text-muted">
            Credential bruteforce attacks using Hydra with popular wordlists.
          </p>

          <Input
            label="Target"
            placeholder="192.168.1.100 or example.com"
            value={bruteforceConfig.target}
            onChange={(e) => setBruteforceConfig({...bruteforceConfig, target: e.target.value})}
          />

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-grok-text-body mb-2">
                Service
              </label>
              <select
                value={bruteforceConfig.service}
                onChange={(e) => {
                  const service = e.target.value;
                  const portMap: Record<string, number> = {
                    SSH: 22, FTP: 21, RDP: 3389, HTTP: 80
                  };
                  setBruteforceConfig({
                    ...bruteforceConfig,
                    service,
                    port: portMap[service] || 22
                  });
                }}
                className="w-full px-3 py-2 bg-grok-surface-2 border border-grok-border rounded text-grok-text-body focus:outline-none focus:ring-2 focus:ring-grok-recon-blue"
              >
                <option value="SSH">SSH</option>
                <option value="FTP">FTP</option>
                <option value="RDP">RDP</option>
                <option value="HTTP">HTTP</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-grok-text-body mb-2">
                Port
              </label>
              <Input
                type="number"
                value={bruteforceConfig.port}
                onChange={(e) => setBruteforceConfig({...bruteforceConfig, port: parseInt(e.target.value) || 22})}
                placeholder="22"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-grok-text-body mb-2">
              Wordlist
            </label>
            <select
              value={bruteforceConfig.wordlist}
              onChange={(e) => setBruteforceConfig({...bruteforceConfig, wordlist: e.target.value})}
              className="w-full px-3 py-2 bg-grok-surface-2 border border-grok-border rounded text-grok-text-body focus:outline-none focus:ring-2 focus:ring-grok-recon-blue"
            >
              <option value="rockyou.txt">rockyou.txt</option>
              <option value="fasttrack.txt">fasttrack.txt</option>
              <option value="common-passwords.txt">common-passwords.txt</option>
            </select>
          </div>

          <Button onClick={handleStartBruteforce} isLoading={isExploiting} variant="danger" className="w-full">
            <Shield className="w-4 h-4 mr-2" />
            Start Bruteforce Attack
          </Button>
        </div>
      </Panel>

      {/* Exploitation Results */}
      <Panel title="Exploitation Results">
        <ExploitationResultsList onViewResult={handleViewResult} />
      </Panel>

      {/* Warning */}
      <div className="bg-grok-error/10 border border-grok-error/30 rounded-lg p-4">
        <p className="text-sm text-grok-error font-medium">
          Warning: Only use exploitation features against systems you own or have
          explicit permission to test. Unauthorized access is illegal.
        </p>
      </div>
    </div>
  );
}
