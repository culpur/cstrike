#!/bin/bash
# Exploitation Module Backend Integration - Verification Script
# Run this script to verify the implementation is correct

echo "=============================================="
echo "Exploitation Module Integration Verification"
echo "=============================================="
echo ""

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

PASS=0
FAIL=0

# Test 1: Syntax Check
echo -n "Test 1: Python Syntax Validation... "
if python3 -m py_compile api_server.py 2>/dev/null && python3 -m py_compile modules/exploitation.py 2>/dev/null; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 2: Import Check
echo -n "Test 2: Import Validation... "
if python3 -c "from modules.exploitation import run_exploitation_chain, run_bruteforce_enumeration; from modules.utils import get_target_dir" 2>/dev/null; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 3: Function Signature Check
echo -n "Test 3: Function Signatures... "
if python3 -c "
import inspect
from modules.exploitation import run_exploitation_chain, run_web_exploitation

sig1 = inspect.signature(run_exploitation_chain)
sig2 = inspect.signature(run_web_exploitation)

assert 'enabled_tools' in sig1.parameters
assert 'enabled_tools' in sig2.parameters
assert sig1.parameters['enabled_tools'].default == ['nuclei', 'ffuf']
assert sig2.parameters['enabled_tools'].default == ['nuclei', 'ffuf']
" 2>/dev/null; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 4: API Endpoint Check (requires server not running)
echo -n "Test 4: Endpoint Definition Check... "
if grep -q "def start_exploitation" api_server.py && grep -q "def start_bruteforce" api_server.py; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 5: Tool Configuration Check
echo -n "Test 5: Tool Configuration Logic... "
if grep -q "'nuclei' in enabled_tools" modules/exploitation.py && grep -q "'ffuf' in enabled_tools" modules/exploitation.py; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 6: Documentation Check
echo -n "Test 6: Documentation Files... "
if [ -f "EXPLOITATION_API_TESTS.md" ] && [ -f "EXPLOITATION_BACKEND_INTEGRATION_SUMMARY.md" ] && [ -f "EXPLOITATION_API_QUICK_REFERENCE.md" ]; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 7: Import Lines Check
echo -n "Test 7: Required Imports Present... "
if grep -q "from modules.exploitation import run_exploitation_chain, run_bruteforce_enumeration" api_server.py && \
   grep -q "from modules.utils import get_target_dir" api_server.py; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Test 8: WebSocket Events Check
echo -n "Test 8: WebSocket Event Emission... "
if grep -q "socketio.emit('exploit_result'" api_server.py && \
   grep -q "'tools': tools" api_server.py; then
    echo -e "${GREEN}PASS${NC}"
    ((PASS++))
else
    echo -e "${RED}FAIL${NC}"
    ((FAIL++))
fi

# Results
echo ""
echo "=============================================="
echo "Test Results"
echo "=============================================="
echo -e "${GREEN}PASSED: ${PASS}/8${NC}"
if [ $FAIL -gt 0 ]; then
    echo -e "${RED}FAILED: ${FAIL}/8${NC}"
fi
echo ""

if [ $FAIL -eq 0 ]; then
    echo -e "${GREEN}✓ All tests passed! Implementation verified.${NC}"
    echo ""
    echo "Next Steps:"
    echo "1. Restart API server: sudo systemctl restart cstrike-api"
    echo "2. Test exploitation endpoint:"
    echo "   curl -X POST http://localhost:5000/api/v1/exploit/start \\"
    echo "     -H 'Content-Type: application/json' \\"
    echo "     -d '{\"target\": \"testbox.local\", \"tools\": [\"nuclei\"]}'"
    echo ""
    echo "3. Test bruteforce endpoint:"
    echo "   curl -X POST http://localhost:5000/api/v1/exploit/bruteforce \\"
    echo "     -H 'Content-Type: application/json' \\"
    echo "     -d '{\"target\": \"testbox.local\", \"service\": \"ssh\"}'"
    echo ""
    exit 0
else
    echo -e "${RED}✗ Some tests failed. Please review the implementation.${NC}"
    echo ""
    echo "Troubleshooting:"
    echo "- Check syntax errors: python3 -m py_compile api_server.py"
    echo "- Verify imports: python3 -c 'from modules.exploitation import *'"
    echo "- Review documentation: cat EXPLOITATION_BACKEND_INTEGRATION_SUMMARY.md"
    echo ""
    exit 1
fi
